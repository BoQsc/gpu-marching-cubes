# GPU Marching Cubes - Developer Notes

## GPU Resource Cleanup (Building System)

**File:** `building_system/building_mesher.gd`  
**Toggle:** `ENABLE_GPU_CLEANUP` (line ~26)

### If you experience crashes during building/mesh generation:

1. Open `building_system/building_mesher.gd`
2. Find `const ENABLE_GPU_CLEANUP: bool = true`
3. Change to `false`
4. Test if crashes stop

### Background:
- The original code had GPU resource freeing disabled due to crashes
- We re-enabled it with correct freeing order (uniform_set first, then textures/sampler)
- Tested working on Godot 4.5 without crashes
- If crashes return, the freeing order may need more research

### Trade-off:
- **Cleanup ON:** No GPU memory leak
- **Cleanup OFF:** Leaks ~32KB per mesh generation (~3MB per 100 blocks placed)

---

## Slope-Based Cliff Rock Texture

**File:** `marching_cubes/terrain.gdshader`  
**Uniform:** `surface_cliff_threshold` (default: 10.0)

### What it does:
- Applies a rocky texture to steep surfaces (cliffs) based on surface normal angle
- Only active **above** `surface_cliff_threshold` Y level (default Y=10)
- Underground areas show raw materials (stone, ore, etc.) for gameplay clarity

### Potential Gameplay Issue:
> ⚠️ **FUTURE CONSIDERATION:** Players mining near the surface may not see the actual terrain materials (stone, ore, gravel) because the rocky cliff texture overlays them. This is purely visual enhancement and may need to:
> - Be reduced in intensity
> - Have the threshold lowered further
> - Be removed entirely if it causes confusion during early mining

### How to adjust:
1. **Change threshold:** Modify `surface_cliff_threshold` in the shader material (lower = less rocky texture near surface)
2. **Reduce intensity:** In the shader, find `cliff_mix` calculation and multiply by a value < 1.0
3. **Disable entirely:** Comment out the cliff rock blending section (lines ~190-198)

### Current behavior:
- Y 8-12: Smooth transition zone
- Y < 8: No rocky texture (shows actual materials)

---

## Road Edge Blending

**File:** `marching_cubes/terrain.gdshader`  
**Uniforms:** `road_edge_blend_enabled`, `road_edge_blend_width`

### Current Status:
> ⚠️ **Working but not perfect.** Road edge blending has some asymmetry due to Marching Cubes mesh boundary variations. The blend zone uses a fixed distance calculation (`procedural_road_width * 0.43`), but the actual road mesh edge varies with terrain height/slope.

### Why it's imperfect:
- Road **geometry** (mesh) is generated by density shader with smooth blending
- Road **material** (mat_id 6) is assigned with stricter bounds + height check
- The visual road edge depends on both, creating inconsistent boundaries
- Shader blend uses fixed distance, cannot adapt to per-pixel mesh variations

### Potential future fix:
- Pass actual mesh boundary info from density to terrain shader (complex)
- Or accept the current "good enough" state

---

## Vehicle System

**Directory:** `vehicles/`, `addons/srcoder_simplecar/`

### Current Status:
> ⚠️ **Vehicles are hard to deal with.** The current vehicle system works but has known limitations due to lack of experience in vehicle physics tuning.

### Known Issues:
- **Camera behavior:** Getting the follow camera to behave correctly (decoupled from car rotation, smooth lag, etc.) is tricky with Godot's scene hierarchy
- **Physics tuning:** Car handling requires careful balance of mass, grip, suspension stiffness, and damping - easy to make the car feel "floaty" or unstable
- **High-speed stability:** Cars can become difficult to control at high speeds

### What's working:
- Basic driving with WASD controls
- Enter/exit vehicle interaction
- Vehicle save/load integration
- Deferred spawning (waits for terrain)
- Water physics (buoyancy)
- Flip recovery (B key)

### Future improvements needed:
- Better camera system (possibly custom, not child of car)
- More refined physics parameters
- Possibly switch to a different vehicle addon/approach

---

## Zombie Entity System

**Directory:** `entities/`  
**Files:** `zombie_base.gd`, `zombie_base.tscn`

### Spawning:
- **F10:** Spawn default capsule entity
- **F11:** Spawn zombie

### Known quirks:

#### Floating Gap Fix
- **Issue:** Zombies appear to float slightly above terrain
- **Cause:** `safe_margin` property on CharacterBody3D adds a buffer distance
- **Fix:** Set `safe_margin = 0.04` (4cm) instead of default 0.2 (20cm)
- Also adjust model Y position in scene if needed

#### Model Facing Direction
- **Issue:** GLB model faces backwards (negative Z is forward)
- **Fix:** Rotate the model node 180° in the scene file (negate X and Z scale)
- Do NOT use `rotate_y(PI)` in code - cleaner to fix in scene

### Animation System:
Uses **time-slice animation** on a single "Take 001" animation:
- Idle: 0-1s
- Walk/Chase: 1-2s
- Attack: 3.5-4.5s
- Death: 9.5s+

### Deferred Spawning (Dec 2024):
Entities wait for terrain before spawning:
1. Spawn request added to queue
2. Each frame, queue is checked - spawns only when terrain is ready AND within spawn_radius
3. If player moves away, pending spawn is cancelled

### Terrain Collision Issue:
> ⚠️ **NEEDS MORE WORK:** When player moves far away, terrain chunks unload and entities lose collision, causing them to fall through.

**Current workaround:** `despawn_radius` (80m) is set lower than terrain load distance (~155m) so entities are removed before terrain unloads.

**Future improvements needed:**
- Freeze/pause far entities instead of relying on despawn timing
- Or: Keep terrain collision loaded slightly longer than visual mesh
- Or: Store entity positions and re-place them when player returns
